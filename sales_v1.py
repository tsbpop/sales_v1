import streamlit as st
import pandas as pd

st.title("ğŸ“¦ ìƒí’ˆ êµ¬ì„± í™•ì¸")

# 1. ì—‘ì…€ ì—…ë¡œë“œ
uploaded_file = st.file_uploader("ğŸ“ 'ìƒí’ˆ' ì‹œíŠ¸ì™€ 'íŒë§¤' ì‹œíŠ¸ê°€ ìˆëŠ” Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”", type=["xlsx"])

if uploaded_file:
    try:
        # 2. ì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
        ìƒí’ˆ_df = pd.read_excel(uploaded_file, sheet_name='ìƒí’ˆ')
        íŒë§¤_df = pd.read_excel(uploaded_file, sheet_name='íŒë§¤')

        # 3. ë³‘í•© ì…€ ëŒ€ì‘
        ìƒí’ˆ_df['ìƒí’ˆ'] = ìƒí’ˆ_df['ìƒí’ˆ'].fillna(method='ffill')
        íŒë§¤_df['ì¼'] = íŒë§¤_df['ì¼'].fillna(method='ffill')
        íŒë§¤_df['ìƒí’ˆëª…'] = íŒë§¤_df['ìƒí’ˆëª…'].fillna(method='ffill')

        # 4. ë‚ ì§œ ì²˜ë¦¬
        íŒë§¤_df['ì¼'] = pd.to_datetime(íŒë§¤_df['ì¼'])

        # 5. êµ¬ì„±í’ˆ ê²€ìƒ‰
        êµ¬ì„±í’ˆ_ê²€ìƒ‰ì–´ = st.text_input("ğŸ” êµ¬ì„±í’ˆì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì´ˆì½œë¦¿)")

        # 6. ë‚ ì§œ ë²”ìœ„
        st.write("ğŸ—“ï¸ ì¡°íšŒ ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”:")
        ì‹œì‘ì¼ = st.date_input("ì‹œì‘ì¼", value=íŒë§¤_df['ì¼'].min().date())
        ì¢…ë£Œì¼ = st.date_input("ì¢…ë£Œì¼", value=íŒë§¤_df['ì¼'].max().date())

        if êµ¬ì„±í’ˆ_ê²€ìƒ‰ì–´:
            # 7. ê´€ë ¨ ìƒí’ˆëª… í•„í„°
            ìƒí’ˆëª…_ë¦¬ìŠ¤íŠ¸ = ìƒí’ˆ_df[ìƒí’ˆ_df['êµ¬ì„±í’ˆ'].str.contains(êµ¬ì„±í’ˆ_ê²€ìƒ‰ì–´, na=False)]['ìƒí’ˆ'].dropna().tolist()
            ìƒí’ˆëª…_ë¦¬ìŠ¤íŠ¸ = [x for x in ìƒí’ˆëª…_ë¦¬ìŠ¤íŠ¸ if str(x).strip() != ""]
            st.write("ğŸ“¦ í•´ë‹¹ êµ¬ì„±í’ˆì´ í¬í•¨ëœ ìƒí’ˆ:", ìƒí’ˆëª…_ë¦¬ìŠ¤íŠ¸)

            # 8. íŒë§¤ í•„í„°
            íŒë§¤_í•„í„° = íŒë§¤_df[
                (íŒë§¤_df['ìƒí’ˆëª…'].isin(ìƒí’ˆëª…_ë¦¬ìŠ¤íŠ¸)) &
                (íŒë§¤_df['ì¼'].dt.date >= ì‹œì‘ì¼) &
                (íŒë§¤_df['ì¼'].dt.date <= ì¢…ë£Œì¼)
            ]

            # 9. ìƒí’ˆ+ì¼ìë³„ ì§‘ê³„
            ì§‘ê³„ = íŒë§¤_í•„í„°.groupby(['ì¼', 'ìƒí’ˆëª…'], as_index=False)[['ê±°ë˜ê±´ìˆ˜', 'ê±°ë˜ê¸ˆì•¡']].sum()

            # 10. ë¹„ì¤‘ ê³„ì‚°
            ì „ì²´_ê¸ˆì•¡ = íŒë§¤_df.groupby('ì¼')['ê±°ë˜ê¸ˆì•¡'].sum()
            ì§‘ê³„['ë¹„ì¤‘(%)'] = ì§‘ê³„.apply(lambda row: round(row['ê±°ë˜ê¸ˆì•¡'] / ì „ì²´_ê¸ˆì•¡[row['ì¼']] * 100, 2), axis=1)

            # 11. ìˆ«ì í¬ë§·
            ì§‘ê³„['ê±°ë˜ê¸ˆì•¡'] = ì§‘ê³„['ê±°ë˜ê¸ˆì•¡'].apply(lambda x: f"{x:,.0f}")
            ì§‘ê³„['ë¹„ì¤‘(%)'] = ì§‘ê³„['ë¹„ì¤‘(%)'].apply(lambda x: f"{x:.2f}%")

            # 12. ê²°ê³¼ í‘œì‹œ
            st.write("ğŸ“Š ë¶„ì„ ê²°ê³¼:")
            st.dataframe(ì§‘ê³„[['ì¼', 'ìƒí’ˆëª…', 'ê±°ë˜ê±´ìˆ˜', 'ê±°ë˜ê¸ˆì•¡', 'ë¹„ì¤‘(%)']])

            # 13. ìƒí’ˆ êµ¬ì„± ë³´ê¸°
            ì„ íƒìƒí’ˆ = st.selectbox("ğŸ” êµ¬ì„±í’ˆì„ ë³´ê³  ì‹¶ì€ ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”", sorted(set(ì§‘ê³„['ìƒí’ˆëª…'])))
            êµ¬ì„±ì •ë³´ = ìƒí’ˆ_df[ìƒí’ˆ_df['ìƒí’ˆ'] == ì„ íƒìƒí’ˆ][['êµ¬ì„±í’ˆ', 'ê°œìˆ˜']].drop_duplicates()
            st.write(f"ğŸ“‹ **{ì„ íƒìƒí’ˆ}**ì˜ êµ¬ì„± (ì¤‘ë³µ ì œì™¸):")
            st.dataframe(êµ¬ì„±ì •ë³´.reset_index(drop=True))


    except Exception as e:
        st.error(f"âŒ ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
